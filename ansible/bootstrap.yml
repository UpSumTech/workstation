---
# This playbook bootstraps a local machine

- hosts: all
  sudo: yes

  tasks:
    - apt:
      utils:
        - slay # cleanly kill all user processes with this utility

    - name: remove-existing-user-and-group
      shell: >
        ps U {{ user }}; \
        slay -clean {{ user }}; \
        deluser {{ user }} --remove-all-files; \
        groupdel {{ user }}
      args:
        executable: /bin/bash
      ignore_errors: yes

    - name: Add a user group
      group: name={{ user }}
              system=yes
              state=present

    - name: Adds a user to the previous and sudo groups
      user: name={{ user }}
            system=yes
            createhome=true
            shell=/bin/bash
            generate_ssh_key=yes
            group={{ user }}
            groups=sudo
            append=yes

    - name: Add an entry to the sudoers.d directory
      shell: echo "{{ user }} ALL=(ALL) NOPASSWD:ALL" > "/etc/sudoers.d/{{ user }}"

    - authorized_key: user={{ user }} key="{{ lookup('file', '~/.ssh/id_rsa.pub') }}" exclusive=yes
